# Restore Point: RP-P8A-post-20260213

## Phase Reference
- **Project:** AMS–RVM Core (v1)
- **Phase:** 8A (CRUD Write Flows + Workflow Enforcement + Audit Readiness)
- **Type:** Post-Phase Checkpoint
- **Created:** 2026-02-13

---

## Changes Applied

### New Table
| Table | Purpose |
|-------|---------|
| `status_transitions` | Lookup table for valid workflow state transitions (22 rows) |

### New Functions (10)
| Function | Type | Purpose |
|----------|------|---------|
| `validate_status_transition(text,text,text)` | SECURITY DEFINER | Validates state transitions via lookup table |
| `enforce_dossier_status_transition()` | TRIGGER | Dossier workflow guard |
| `enforce_meeting_status_transition()` | TRIGGER | Meeting workflow guard |
| `enforce_task_status_transition()` | TRIGGER | Task workflow guard + timestamp automation |
| `enforce_agenda_item_status_transition()` | TRIGGER | Agenda item workflow guard + closed meeting check |
| `enforce_chair_approval_gate()` | TRIGGER | Chair RVM approval enforcement + dossier cascade |
| `enforce_dossier_immutability()` | TRIGGER | Blocks writes to locked dossier children |
| `enforce_document_lock_on_decision()` | TRIGGER | Blocks document versions after decision finalized |
| `log_audit_event()` | SECURITY DEFINER TRIGGER | Generic audit logging for all domain tables |

### New Triggers (20 total, 12 new)
| Table | Trigger | Event |
|-------|---------|-------|
| `rvm_dossier` | `enforce_dossier_status_transition` | BEFORE UPDATE |
| `rvm_dossier` | `audit_rvm_dossier` | AFTER INSERT OR UPDATE |
| `rvm_meeting` | `enforce_meeting_status_transition` | BEFORE UPDATE |
| `rvm_meeting` | `audit_rvm_meeting` | AFTER INSERT OR UPDATE |
| `rvm_task` | `enforce_task_status_transition` | BEFORE UPDATE |
| `rvm_task` | `audit_rvm_task` | AFTER INSERT OR UPDATE |
| `rvm_agenda_item` | `enforce_agenda_item_status_transition` | BEFORE UPDATE |
| `rvm_agenda_item` | `audit_rvm_agenda_item` | AFTER INSERT OR UPDATE |
| `rvm_decision` | `enforce_chair_approval_gate` | BEFORE UPDATE |
| `rvm_decision` | `audit_rvm_decision` | AFTER INSERT OR UPDATE |
| `rvm_item` | `enforce_dossier_immutability_item` | BEFORE INSERT OR UPDATE |
| `rvm_item` | `audit_rvm_item` | AFTER INSERT OR UPDATE |
| `rvm_document` | `enforce_dossier_immutability_document` | BEFORE INSERT OR UPDATE |
| `rvm_document` | `audit_rvm_document` | AFTER INSERT OR UPDATE |
| `rvm_document_version` | `enforce_document_lock_on_decision` | BEFORE INSERT |
| `rvm_document_version` | `audit_rvm_document_version` | AFTER INSERT |

### RLS Policies Added
| Table | Policy | Command | Expression |
|-------|--------|---------|------------|
| `status_transitions` | `status_transitions_select` | SELECT | `auth.uid() IS NOT NULL` |
| `status_transitions` | `status_transitions_no_insert` | INSERT | `false` |
| `status_transitions` | `status_transitions_no_update` | UPDATE | `false` |
| `status_transitions` | `status_transitions_no_delete` | DELETE | `false` |

### Privilege Hardening
- `REVOKE ALL ON FUNCTION log_audit_event() FROM PUBLIC`
- `REVOKE ALL ON FUNCTION log_audit_event() FROM anon`

## Verification Results
- ✅ `validate_status_transition('dossier','draft','registered')` = true
- ✅ `validate_status_transition('dossier','draft','decided')` = false
- ✅ `validate_status_transition('task','todo','in_progress')` = true
- ✅ `validate_status_transition('meeting','draft','closed')` = false
- ✅ `audit_event` has SELECT-only policy (immutable)
- ✅ `status_transitions` has explicit write-deny policies
- ✅ `log_audit_event()` privilege: postgres, authenticated, service_role only

## No Code Changes
Phase 8A is database-only. No frontend or service layer code was modified.

---

## Rollback
See `Project Restore Points/RP-P8A-pre-20260213.md` for full rollback SQL.
