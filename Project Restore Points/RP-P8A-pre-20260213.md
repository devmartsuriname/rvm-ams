# Restore Point: RP-P8A-pre-20260213

## Phase Reference
- **Project:** AMSâ€“RVM Core (v1)
- **Phase:** 8A (CRUD Write Flows + Workflow Enforcement + Audit Readiness)
- **Type:** Pre-Phase Checkpoint
- **Created:** 2026-02-13

---

## Database State (Before Changes)

### Existing Triggers
| Table | Trigger | Function |
|-------|---------|----------|
| `rvm_dossier` | `trg_generate_dossier_number` | `generate_dossier_number()` |
| `rvm_dossier` | `update_rvm_dossier_updated_at` | `update_updated_at_column()` |
| `rvm_decision` | `update_rvm_decision_updated_at` | `update_updated_at_column()` |
| `rvm_task` | `update_rvm_task_updated_at` | `update_updated_at_column()` |

### Tables
- `status_transitions`: Does NOT exist
- No workflow enforcement triggers
- No audit logging triggers
- No chair approval gate trigger
- No dossier immutability triggers
- No document version lock trigger

### RLS Policies
- All SELECT policies hardened (Phase 7C)
- INSERT/UPDATE policies exist per role matrix
- No DELETE policies (by design)
- `audit_event`: SELECT only for `audit_readonly` + `is_super_admin()`

### Functions
- `get_current_user_id()`, `get_user_roles()`, `has_role()`, `has_any_role()`, `is_super_admin()`
- `validate_status_transition()`: Does NOT exist
- `log_audit_event()`: Does NOT exist
- `enforce_*` functions: Do NOT exist

---

## Rollback Instructions

To restore to this point:
1. Drop all Phase 8A triggers (enforce_*, audit_*)
2. Drop all Phase 8A functions (validate_status_transition, enforce_*, log_audit_event)
3. Drop `status_transitions` table
4. No code changes to revert (Phase 8A is DB-only)

```sql
-- Drop audit triggers
DROP TRIGGER IF EXISTS audit_rvm_dossier ON rvm_dossier;
DROP TRIGGER IF EXISTS audit_rvm_item ON rvm_item;
DROP TRIGGER IF EXISTS audit_rvm_task ON rvm_task;
DROP TRIGGER IF EXISTS audit_rvm_meeting ON rvm_meeting;
DROP TRIGGER IF EXISTS audit_rvm_agenda_item ON rvm_agenda_item;
DROP TRIGGER IF EXISTS audit_rvm_decision ON rvm_decision;
DROP TRIGGER IF EXISTS audit_rvm_document ON rvm_document;
DROP TRIGGER IF EXISTS audit_rvm_document_version ON rvm_document_version;

-- Drop workflow triggers
DROP TRIGGER IF EXISTS enforce_dossier_status_transition ON rvm_dossier;
DROP TRIGGER IF EXISTS enforce_meeting_status_transition ON rvm_meeting;
DROP TRIGGER IF EXISTS enforce_task_status_transition ON rvm_task;
DROP TRIGGER IF EXISTS enforce_agenda_item_status_transition ON rvm_agenda_item;
DROP TRIGGER IF EXISTS enforce_chair_approval_gate ON rvm_decision;
DROP TRIGGER IF EXISTS enforce_dossier_immutability_item ON rvm_item;
DROP TRIGGER IF EXISTS enforce_dossier_immutability_document ON rvm_document;
DROP TRIGGER IF EXISTS enforce_document_lock_on_decision ON rvm_document_version;

-- Drop functions
DROP FUNCTION IF EXISTS log_audit_event();
DROP FUNCTION IF EXISTS enforce_dossier_status_transition();
DROP FUNCTION IF EXISTS enforce_meeting_status_transition();
DROP FUNCTION IF EXISTS enforce_task_status_transition();
DROP FUNCTION IF EXISTS enforce_agenda_item_status_transition();
DROP FUNCTION IF EXISTS enforce_chair_approval_gate();
DROP FUNCTION IF EXISTS enforce_dossier_immutability();
DROP FUNCTION IF EXISTS enforce_document_lock_on_decision();
DROP FUNCTION IF EXISTS validate_status_transition(TEXT, TEXT, TEXT);

-- Drop table
DROP TABLE IF EXISTS status_transitions;
```
