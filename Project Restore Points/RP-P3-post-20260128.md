# Restore Point: RP-P3-post-20260128

## Phase Context
- **Project:** AMS–RVM Core (v1)
- **Restore Point ID:** RP-P3-post-20260128
- **Created:** 2026-01-28
- **Purpose:** Post-Phase 3 checkpoint (Workflow Engine & RLS Deepening complete)

---

## Database State

### Identity Schema (Phase 1)
| Table | Status | RLS |
|-------|--------|-----|
| `app_user` | Deployed | Role-based SELECT (self + privileged) |
| `app_role` | Deployed | Public SELECT |
| `user_role` | Deployed | Self + privileged SELECT |
| `super_admin_bootstrap` | Deployed | Self + sys_admin SELECT |

### Domain Schema (Phase 2B → Phase 3 RLS)
| Table | RLS Status | SELECT | INSERT | UPDATE |
|-------|------------|--------|--------|--------|
| `missive_keyword` | Role-based | All auth | rvm_sys_admin | rvm_sys_admin |
| `rvm_dossier` | Role-based | All RVM roles | admin_intake | secretary_rvm, admin_dossier (state-dependent) |
| `rvm_item` | Role-based | All RVM roles | admin_intake | secretary_rvm, admin_dossier |
| `rvm_meeting` | Role-based | All RVM roles | secretary_rvm, admin_agenda | secretary_rvm, admin_agenda (not closed) |
| `rvm_agenda_item` | Role-based | All RVM roles | secretary_rvm, admin_agenda | secretary_rvm, admin_agenda |
| `rvm_decision` | Role-based | chair/secretary/deputy/reporting/audit | secretary_rvm, admin_reporting | secretary_rvm (draft), chair_rvm (finalize) |
| `rvm_document` | Role-based | All RVM roles + audit | secretary_rvm, admin_dossier, admin_reporting | secretary_rvm, admin_dossier |
| `rvm_document_version` | Role-based | All RVM roles + audit | secretary_rvm, admin_dossier, admin_reporting | None (immutable) |
| `rvm_task` | Role-based | Assigned role + secretary/deputy | secretary_rvm, deputy_secretary | Own tasks + secretary/deputy |
| `audit_event` | SELECT-only | audit_readonly, secretary_rvm, rvm_sys_admin | None (Phase 8) | None |

### Helper Functions (Phase 3 Additions)
| Function | Purpose |
|----------|---------|
| `is_dossier_editable(UUID)` | Check dossier state allows edits |
| `is_meeting_editable(UUID)` | Check meeting state allows edits |
| `is_decision_draft(UUID)` | Check decision is not finalized |
| `is_task_assignee(UUID)` | Check current user is task assignee |

---

## Frontend State

### Authentication
| Component | Status |
|-----------|--------|
| Dev Bypass Shim | RETIRED |
| Auth Provider | Supabase `onAuthStateChange` listener |
| Sign-In Hook | Uses `supabase.auth.signInWithPassword()` |
| Session Management | Supabase built-in persistence |

### Key Files Modified
- `src/context/useAuthContext.tsx` — Supabase auth integration
- `src/app/(other)/auth/sign-in/useSignIn.ts` — signInWithPassword
- `src/types/auth.ts` — Added auth_id, roles array

---

## RLS Matrix Summary

| Entity | chair_rvm | secretary_rvm | deputy_secretary | admin_intake | admin_dossier | admin_agenda | admin_reporting | audit_readonly |
|--------|-----------|---------------|------------------|--------------|---------------|--------------|-----------------|----------------|
| rvm_dossier | R | RU | R | RCU | RU | R | R | R |
| rvm_item | R | RU | - | RCU | RU | - | - | R |
| rvm_meeting | R | RCU | - | - | - | RCU | - | R |
| rvm_agenda_item | R | RCU | - | - | - | RCU | - | R |
| rvm_decision | RU* | RCU | R | - | - | - | RC | R |
| rvm_document | R | RCU | - | - | RCU | - | RCU | R |
| rvm_document_version | R | RC | - | - | RC | - | RC | R |
| rvm_task | R | RCU | RCU | R† | R† | R† | R† | - |
| audit_event | - | R | - | - | - | - | - | R |

**Legend:** R=Read, C=Create, U=Update, *=Finalization only, †=Own tasks only

---

## Deferred Items (Documented)

### Deferred to Phase 5 (Decision Management)
- `prevent_decision_modification()` trigger

### Deferred to Phase 8 (Audit Finalization)
- `log_audit_event()` function
- `prevent_audit_modification()` trigger
- `prevent_audit_deletion()` trigger
- Audit INSERT policy for controlled insertion

### Deferred to Future Phase
- Sign-up flow wiring
- Password reset flow

---

## Migration Applied
```
20260128_phase3_role_rls_workflow_helpers.sql
- Dropped all baseline RLS policies
- Created role-based RLS for 10 domain tables
- Created 4 workflow state helper functions
```

---

## Verification Status

| Check | Status |
|-------|--------|
| RLS policies deployed | ✓ |
| Workflow helpers deployed | ✓ |
| Supabase auth integrated | ✓ |
| Sign-in functional | ✓ |
| Dev bypass retired | ✓ |
| TypeScript types updated | ✓ |

---

## Recovery Instructions

To restore to this point:
1. Ensure Phase 3 migration is applied
2. Restore frontend files from this commit
3. Verify Supabase auth configuration

---

## Phase Completion Summary

| Deliverable | Status |
|-------------|--------|
| Pre-Phase Restore Point | RP-P3-pre-20260128 |
| Role-based RLS | DONE (10 tables) |
| Workflow Helpers | DONE (4 functions) |
| Supabase Auth Integration | DONE (sign-in only) |
| TypeScript Types | DONE |
| Dev Bypass Retirement | DONE |
| Post-Phase Restore Point | RP-P3-post-20260128 |

**Phase 3 Status:** COMPLETE

**Next Phase:** Phase 4 (Agenda Management) — Awaiting Authorization
