# Restore Point: RP-P2-post-20260128

## Phase Reference
- **Project:** AMS–RVM Core (v1)
- **Phase:** 2 (Core Domain — DB Foundation)
- **Type:** Post-Phase Checkpoint
- **Created:** 2026-01-28

---

## Phase 2 Completion Summary

### DONE
| Item | Status |
|------|--------|
| Disable Fake Auth Backend | ✅ `configureFakeBackend()` removed from App.tsx |
| Dev Bypass Shim | ✅ Added to useAuthContext.tsx (temporary) |
| Identity Tables | ✅ `app_user`, `app_role`, `user_role`, `super_admin_bootstrap` |
| RLS Helper Functions | ✅ 5 SECURITY DEFINER functions |
| Seed Role Data | ✅ 9 RVM roles inserted |
| Enable RLS | ✅ All 4 identity tables |
| RLS Policies | ✅ SELECT policies on all tables |
| Indexes | ✅ 6 performance indexes |
| Updated_at Trigger | ✅ Automatic timestamp on app_user |

### SKIPPED
- None

### DEFERRED
| Item | Reason |
|------|--------|
| INSERT/UPDATE/DELETE policies | Requires user provisioning workflow (Phase 3+) |
| Super Admin user creation | Requires explicit authorization |
| Auth UI flows | Requires Phase 3 authorization |
| Business logic | Phase 3+ scope |

---

## Database State

### Tables
| Table | Rows | RLS |
|-------|------|-----|
| `app_user` | 0 | Enabled |
| `app_role` | 9 | Enabled |
| `user_role` | 0 | Enabled |
| `super_admin_bootstrap` | 0 | Enabled |

### Functions
| Function | Type |
|----------|------|
| `get_current_user_id()` | SECURITY DEFINER |
| `get_user_roles()` | SECURITY DEFINER |
| `has_role(TEXT)` | SECURITY DEFINER |
| `has_any_role(TEXT[])` | SECURITY DEFINER |
| `is_super_admin()` | SECURITY DEFINER |
| `update_updated_at_column()` | TRIGGER |

### Indexes
- `idx_app_user_auth_id`
- `idx_app_user_email`
- `idx_app_user_active` (partial)
- `idx_user_role_user`
- `idx_user_role_code`
- `idx_super_admin_auth`

---

## Codebase State

### Modified Files
| File | Change |
|------|--------|
| `src/App.tsx` | Removed `configureFakeBackend()` call |
| `src/helpers/fake-backend.ts` | Disabled (empty export) |
| `src/context/useAuthContext.tsx` | Added `_AMS_RVM_DEV_MODE_` bypass shim |

### Created Files
| File | Purpose |
|------|---------|
| `Project Restore Points/RP-P2-pre-20260128.md` | Pre-phase checkpoint |
| `Project Restore Points/RP-P2-post-20260128.md` | This file |

---

## Forbidden Scope Compliance

| Item | Status |
|------|--------|
| Business logic | ❌ NOT IMPLEMENTED |
| AMS modules | ❌ NOT IMPLEMENTED |
| Auth UI flows | ❌ NOT IMPLEMENTED |
| Role management UI | ❌ NOT IMPLEMENTED |
| User provisioning UI | ❌ NOT IMPLEMENTED |
| Super Admin user | ❌ NOT CREATED |
| New UI libraries | ❌ NOT ADDED |
| Layout changes | ❌ NOT MODIFIED |
| Styling changes | ❌ NOT MODIFIED |

---

## Dev Bypass Note

A temporary development bypass exists in `useAuthContext.tsx`:
- Key: `localStorage.setItem('_AMS_RVM_DEV_MODE_', 'true')`
- Purpose: Allows admin shell access during Phase 2 development
- **MUST BE REMOVED** when real Supabase auth is implemented (Phase 3+)

---

## Restoration Instructions

To restore to Phase 2 complete state:
1. Ensure all files match this checkpoint
2. Verify database has 4 identity tables with RLS enabled
3. Verify 9 roles exist in `app_role`
4. Verify 5 RLS helper functions exist

---

## HARD STOP

Phase 2 (DB Foundation) is complete.
Awaiting explicit authorization for:
- **Phase 2B:** Core Domain enums/tables (dossier, agenda, decision)
- **Phase 3:** Workflow Engine

---

## Governance Compliance

- ✅ Darkone template parity preserved 1:1
- ✅ No new UI libraries added
- ✅ No layout refactors
- ✅ No styling changes
- ✅ RLS enforced at data layer
- ✅ All changes via versioned migrations
