# Restore Point: RP-P3-pre-20260128

## Phase Context
- **Project:** AMS–RVM Core (v1)
- **Restore Point ID:** RP-P3-pre-20260128
- **Created:** 2026-01-28
- **Purpose:** Pre-Phase 3 checkpoint (before Workflow Engine & RLS Deepening)

---

## Database State

### Identity Schema (Phase 1)
| Table | Status | RLS |
|-------|--------|-----|
| `app_user` | Deployed | Role-based SELECT |
| `app_role` | Deployed | Public SELECT |
| `user_role` | Deployed | Self + privileged SELECT |
| `super_admin_bootstrap` | Deployed | Self + sys_admin SELECT |

### Domain Schema (Phase 2B)
| Table | Status | RLS |
|-------|--------|-----|
| `missive_keyword` | Deployed | Baseline (super_admin) |
| `rvm_dossier` | Deployed | Baseline (super_admin) |
| `rvm_item` | Deployed | Baseline (super_admin) |
| `rvm_meeting` | Deployed | Baseline (super_admin) |
| `rvm_agenda_item` | Deployed | Baseline (super_admin) |
| `rvm_decision` | Deployed | Baseline (super_admin) |
| `rvm_document` | Deployed | Baseline (super_admin) |
| `rvm_document_version` | Deployed | Baseline (super_admin) |
| `rvm_task` | Deployed | Baseline (super_admin) |
| `audit_event` | Deployed | Baseline (super_admin) |

### Enums (12 types)
- `service_type`, `proposal_subtype`, `urgency_level`, `dossier_status`
- `meeting_type`, `meeting_status`, `agenda_item_status`, `decision_status`
- `document_type`, `task_status`, `task_priority`, `task_type`
- `confidentiality_level`

### Helper Functions
| Function | Purpose |
|----------|---------|
| `get_current_user_id()` | Maps auth.uid() to app_user.id |
| `get_user_roles()` | Returns role codes array |
| `has_role(text)` | Single role check |
| `has_any_role(text[])` | Multi-role check |
| `is_super_admin()` | Bootstrap access check |
| `update_updated_at_column()` | Timestamp trigger |
| `generate_dossier_number()` | Auto-numbering |

---

## Frontend State

### Authentication
| Component | Status |
|-----------|--------|
| Dev Bypass Shim | ACTIVE (`_AMS_RVM_DEV_MODE_`) |
| Auth Provider | Cookie/localStorage based |
| Sign-In Hook | Uses `httpClient.post('/login')` |
| Supabase Client | Configured but not wired to auth |

### Key Files
- `src/context/useAuthContext.tsx` — Dev bypass active
- `src/app/(other)/auth/sign-in/useSignIn.ts` — httpClient based
- `src/types/auth.ts` — Missing auth_id and roles array
- `src/helpers/fake-backend.ts` — Disabled (empty function)

---

## Baseline RLS Summary (Pre-Phase 3)

All domain tables have identical baseline pattern:
```sql
-- SELECT: super_admin only
-- INSERT: super_admin only  
-- UPDATE: super_admin only
-- DELETE: denied (no policy)
```

Exception: `missive_keyword` allows authenticated SELECT (reference data)

---

## What Phase 3 Will Change

1. **RLS Policies** — Replace baseline with role-based access matrix
2. **Workflow Helpers** — Add state validation functions
3. **Auth Integration** — Wire Supabase signInWithPassword
4. **Dev Bypass** — Retire localStorage shim
5. **Types** — Add auth_id and roles[] to UserType

---

## Recovery Instructions

To restore to this point:
1. Revert all Phase 3 migrations
2. Restore frontend files from this commit
3. Re-enable dev bypass shim if needed

---

## Migration History
```
Phase 1: Identity schema + RLS helpers
Phase 2: Baseline domain enums
Phase 2B: Domain tables + baseline RLS + indexes
→ Phase 3: (pending) Role-based RLS + workflow helpers
```
