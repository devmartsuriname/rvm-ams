

# PHASE 8C.2 — EDIT FLOWS IMPLEMENTATION PLAN

## PRE-IMPLEMENTATION VERIFICATION

### Prerequisites Status: ✅ ALL CLEAR

| Item | Status | Evidence |
|------|--------|----------|
| Dossier detail page exists | ✅ | `/src/app/(admin)/rvm/dossiers/[id]/page.tsx` (215 lines) |
| Meeting detail page exists | ✅ | `/src/app/(admin)/rvm/meetings/[id]/page.tsx` (198 lines) |
| Dossier service.updateDossier exists | ✅ | `dossierService.updateDossier(id, data)` in service |
| Meeting service.updateMeeting exists | ✅ | `meetingService.updateMeeting(id, data)` in service |
| useUpdateDossier hook exists | ✅ | Implemented with React Query (lines 73-84 in useDossiers.ts) |
| useUpdateMeeting hook exists | ✅ | Implemented with React Query (lines 59-70 in useMeetings.ts) |
| canEditDossier permission gate | ✅ | Already in useUserRoles.ts (line 21) |
| canEditMeeting permission gate | ✅ | Already in useUserRoles.ts (line 26) |
| Create modals exist (reference) | ✅ | CreateDossierModal.tsx, CreateMeetingModal.tsx |

**Blocking Issues Found:** NONE

---

## EDITABLE FIELDS EXTRACTED FROM CREATE FORMS

### Dossier (from CreateDossierModal.tsx)

**Dossier fields** (from lines 10-22 schema):
- `title` (required, string, max 500)
- `service_type` (required, enum: proposal/missive)
- `sender_ministry` (required, string, max 200)
- `urgency` (optional, enum: regular/urgent/special)
- `confidentiality_level` (optional, enum: standard_confidential/restricted/highly_restricted)
- `summary` (optional, string, max 5000)
- `proposal_subtype` (optional if service_type=proposal, enum: OPA/ORAG)

**Item fields** (related rvm_item, from lines 189-217):
- `reference_code` (optional, string, max 100)
- `received_date` (optional, date)
- `description` (optional, string, max 5000)
- `attachments_expected` (optional, boolean)

**Excluded Fields** (not editable per governance):
- `dossier_number` (auto-generated by trigger)
- `id` (PK)
- `status` (managed via status transition mutations, not edit form)
- `created_at`, `updated_at` (system fields)
- `created_by` (immutable)

### Meeting (from CreateMeetingModal.tsx)

**Meeting fields** (from lines 10-14 schema):
- `meeting_date` (required, string)
- `meeting_type` (optional, enum: regular/urgent/special)
- `location` (optional, string, max 500)

**Excluded Fields**:
- `id` (PK)
- `status` (managed via status transitions, not edit)
- `created_at` (system field)
- `created_by` (immutable)

---

## IMMUTABILITY CONSTRAINTS (Backend Enforced)

### Dossier
- RLS policy blocks UPDATE if status IN ('decided', 'archived', 'cancelled')
- UI must disable edit form if dossier.status in locked states
- Reference: `enforce_dossier_immutability()` trigger (from useful context)

### Meeting
- RLS policy blocks UPDATE if status = 'closed'
- UI must disable edit form if meeting.status = 'closed'
- Reference: existing RLS policy in meetingService.ts (line 96 comment)

---

## IMPLEMENTATION APPROACH

### Module 1: EditDossierForm Component

**File:** `src/components/rvm/EditDossierForm.tsx` (NEW)

**Structure:**
- Receive props: `dossier: DossierWithItem`, `onSave: () => void`, `onCancel: () => void`, `isLoading: boolean`
- Local state: `form`, `errors`
- Zod schema: Reuse same schema as CreateDossierModal
- Fields to include:
  - Dossier: title, service_type, sender_ministry, urgency, confidentiality_level, summary, proposal_subtype
  - Item: reference_code, received_date, description, attachments_expected
- Layout: Two-column grid matching CreateDossierModal pattern
- Cancel button: Reverts form state, calls `onCancel()`
- Save button: Validates, calls `onSave(formData)` with dossier and item updates
- Disabled state: `isLoading === true`

**Validation:**
- Same schema as create (no new logic)
- Display inline error messages below fields

---

### Module 2: EditMeetingForm Component

**File:** `src/components/rvm/EditMeetingForm.tsx` (NEW)

**Structure:**
- Props: `meeting: Meeting`, `onSave: () => void`, `onCancel: () => void`, `isLoading: boolean`
- Local state: `form`, `errors`
- Zod schema: Reuse meetingSchema from CreateMeetingModal
- Fields: meeting_date, meeting_type, location
- Layout: Single column (simpler than dossier)
- Cancel/Save buttons with disabled state on `isLoading`

---

### Module 3: Dossier Detail Page Integration

**File:** `src/app/(admin)/rvm/dossiers/[id]/page.tsx` (MODIFY)

**Changes:**
1. Add local state: `const [editMode, setEditMode] = useState(false)`
2. Add UI gate: Only show Edit button if `canEditDossier && !dossier.status in locked states`
3. In CardHeader (Dossier Information card, ~line 62):
   - Add Edit button: `<Button size="sm" variant="outline-primary" onClick={() => setEditMode(true)}>Edit</Button>`
   - Show only if not in edit mode
4. In CardBody (lines 66-119):
   - If `editMode === false`: Show current read-only display (no changes)
   - If `editMode === true`: Render `<EditDossierForm dossier={dossier} onSave={handleSave} onCancel={() => setEditMode(false)} isLoading={isUpdating} />`
5. Add mutation handler:
   ```typescript
   const updateDossier = useUpdateDossier()
   const handleSave = async (formData) => {
     try {
       await updateDossier.mutateAsync({
         id: dossier.id,
         data: { /* extracted dossier fields */ }
       })
       // Item update if applicable (separate service call if needed)
       toast.success('Dossier updated successfully')
       refetch()
       setEditMode(false)
     } catch (error) {
       toast.error(getErrorMessage(error))
     }
   }
   ```
6. Item editing: Deferred if complex; simplest approach is to mark item as read-only in edit form or handle as separate flow

**Immutability Check:**
```typescript
const isEditDisabled = dossier.status && ['decided', 'archived', 'cancelled'].includes(dossier.status)
```

---

### Module 4: Meeting Detail Page Integration

**File:** `src/app/(admin)/rvm/meetings/[id]/page.tsx` (MODIFY)

**Changes:**
1. Add local state: `const [editMode, setEditMode] = useState(false)`
2. Add UI gate: Only show Edit button if `canEditMeeting && meeting.status !== 'closed'`
3. In CardHeader (Meeting Info card, ~line 84):
   - Add Edit button with same pattern as dossier
4. In CardBody (lines 88-109):
   - If `editMode === false`: Show current read-only display (no changes)
   - If `editMode === true`: Render `<EditMeetingForm meeting={meeting} onSave={handleSave} onCancel={() => setEditMode(false)} isLoading={isUpdating} />`
5. Add mutation handler:
   ```typescript
   const updateMeeting = useUpdateMeeting()
   const handleSave = async (formData) => {
     try {
       await updateMeeting.mutateAsync({
         id: meeting.id,
         data: { ...formData }
       })
       toast.success('Meeting updated successfully')
       refetch()
       setEditMode(false)
     } catch (error) {
       toast.error(getErrorMessage(error))
     }
   }
   ```

**Immutability Check:**
```typescript
const isEditDisabled = meeting.status === 'closed'
```

---

## GOVERNANCE CONSTRAINTS COMPLIANCE

| Constraint | Implementation |
|-----------|---|
| No schema changes | ✅ Uses existing dossier/meeting tables |
| No RLS policy changes | ✅ RLS enforced at backend via existing policies |
| No trigger modifications | ✅ Phase 8A triggers fire on UPDATE automatically |
| No new dependencies | ✅ Uses existing Zod, React Bootstrap, React Query |
| Backend authoritative | ✅ UI validation is UX layer only; RLS/triggers enforce final state |
| Immutability enforced | ✅ UI disables form if status locked; backend trigger blocks write |
| Audit events created | ✅ Phase 8A `log_audit_event()` trigger fires on all UPDATEs |

---

## AUDIT VERIFICATION (Automated via Triggers)

When `updateDossier()` or `updateMeeting()` succeeds:
1. Database `log_audit_event()` trigger fires
2. New `audit_event` row created with:
   - `event_type = 'updated'` (or 'status_changed' if status field modified)
   - `event_payload = { old: {...}, new: {...} }`
   - `actor_user_id = current user`
   - `occurred_at = now()`
3. Viewable in `/rvm/audit` page (Phase 8C.1)

No additional code needed for audit logging.

---

## FILES TO BE CREATED/MODIFIED

### NEW FILES
```
src/components/rvm/EditDossierForm.tsx
src/components/rvm/EditMeetingForm.tsx
Project Restore Points/RP-P8C2-pre.md
Project Restore Points/RP-P8C2-post.md
```

### MODIFIED FILES
```
src/app/(admin)/rvm/dossiers/[id]/page.tsx
src/app/(admin)/rvm/meetings/[id]/page.tsx
```

### NOT MODIFIED
```
src/hooks/useDossiers.ts (hooks already exist)
src/hooks/useMeetings.ts (hooks already exist)
src/services/dossierService.ts (service methods already exist)
src/services/meetingService.ts (service methods already exist)
src/hooks/useUserRoles.ts (permissions already exist)
```

---

## BUILD ORDER

1. Create `RP-P8C2-pre.md` restore point
2. Create `EditDossierForm.tsx` component (reusable, no dependencies on detail page)
3. Create `EditMeetingForm.tsx` component (same)
4. Integrate `EditDossierForm` into dossier detail page
5. Integrate `EditMeetingForm` into meeting detail page
6. Manual runtime verification (see Acceptance Criteria below)
7. Create `RP-P8C2-post.md` restore point

---

## ACCEPTANCE CRITERIA & VERIFICATION CHECKLIST

### ✅ DOSSIER EDIT FLOW
- [ ] Edit button visible on dossier detail (not locked status)
- [ ] Click Edit → form renders with current values prefilled
- [ ] Cancel button → reverts to read mode (no write)
- [ ] Save button → calls updateDossier, refetches, shows success toast
- [ ] Invalid state (decided/archived/cancelled) → Edit button disabled
- [ ] Unauthorized user (no canEditDossier) → Edit button not visible
- [ ] Backend RLS blocks write → error toast shown
- [ ] Audit event created on successful save (verify in `/rvm/audit`)

### ✅ MEETING EDIT FLOW
- [ ] Edit button visible on meeting detail (not closed status)
- [ ] Click Edit → form renders with current values prefilled
- [ ] Cancel button → reverts to read mode (no write)
- [ ] Save button → calls updateMeeting, refetches, shows success toast
- [ ] Invalid state (closed) → Edit button disabled
- [ ] Unauthorized user (no canEditMeeting) → Edit button not visible
- [ ] Backend RLS blocks write → error toast shown
- [ ] Audit event created on successful save (verify in `/rvm/audit`)

### ✅ GOVERNANCE
- [ ] No new schema migrations
- [ ] No RLS policy changes
- [ ] No new npm dependencies
- [ ] Service and hook layers unchanged (no new patterns)
- [ ] Darkone styling consistent (Bootstrap, no custom CSS)
- [ ] Single ToastContainer used (no duplicates)

---

## KNOWN LIMITATIONS & DEFERRED SCOPE

1. **Item editing in dossier form**: If complex, defer to future "Item Editor" component
2. **Workflow state machine**: Out of scope; status transitions handled by separate `DossierStatusActions` / `MeetingStatusActions` components
3. **Modal XL standardization**: Noted for UI Polish phase; not refactored in this step
4. **Task edit form**: Deferred to Phase 8C.3 if needed

---

## HARD STOP AFTER COMPLETION

Once all files are created and integrated:
1. Provide summary of what changed and where (file paths)
2. Provide verification results (checklist status)
3. Report any blockers found
4. Declare: **"Await Further Instructions. Do not proceed with Phase 8C.3 without explicit user authorization."**

