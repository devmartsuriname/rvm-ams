

# Phase 8A Runtime Verification — Controlled DML Tests

## Execution Approach

**Option B: SQL execution** — UI write flows are not implemented yet (Phase 8B scope). All tests will be executed via SQL using the Supabase read/analytics tools. The `supabase--read-query` tool operates as `service_role`, which bypasses RLS but does NOT bypass triggers. This is acceptable because:

- All Phase 8A enforcement is implemented as **triggers** (BEFORE UPDATE/INSERT), which fire regardless of role context.
- The `log_audit_event()` function handles NULL `auth.uid()` gracefully (falls back to `actor_role_code = 'system'`).
- RLS enforcement was already verified in Phase 7C; this test validates **trigger logic only**.

## Governance Constraints

- No new features, UI changes, roles, or schema changes.
- Only transient test records created (documented below).
- All evidence captured as SQL output.

## Pre-Test Deliverable

Create `Project Restore Points/RP-P8A-runtime-tests-pre.md` documenting:
- Current audit_event count: 0
- Current rvm_dossier count: 0
- Trigger count: 21 active triggers
- Status transitions: 22 rows

## Test Execution Plan

### TEST 1 — Create Dossier, Verify Audit Event

**Steps:**
1. INSERT into `rvm_dossier` with minimal required fields: `title`, `service_type` (proposal), `sender_ministry`, `dossier_number` (auto-generated by trigger).
2. Query `audit_event` for `entity_type = 'rvm_dossier'` and `event_type = 'created'`.

**Expected:** Insert succeeds. Audit row exists with correct entity_type, entity_id, event_type, and payload containing the new dossier data.

### TEST 2 — Invalid Dossier Transition (draft to decided)

**Steps:**
1. UPDATE the dossier from TEST 1: set `status = 'decided'` (currently 'draft').
2. This should fail because `draft -> decided` is not in `status_transitions`.
3. Query dossier to confirm status remains 'draft'.

**Expected:** Exception: `'Invalid dossier transition: draft -> decided'`. Status unchanged.

### TEST 3 — Chair Approval Gate

**Steps:**
1. Create prerequisite chain: a meeting (draft), an agenda_item linked to the dossier and meeting, and a decision linked to the agenda_item.
2. Attempt to UPDATE `rvm_decision` SET `is_final = true` while `chair_approved_at` and `chair_approved_by` remain NULL.
3. This should fail with the chair approval exception.

**Expected:** Exception: `'Decision cannot be finalized without chair approval'`. `is_final` remains false.

### TEST 4 — Dossier Immutability

**Steps:**
1. Progress the test dossier through the valid transition path: draft -> registered -> in_preparation -> scheduled -> decided (the last step requires a finalized decision with chair approval, so we set up the full chain).
2. Alternative approach: directly update dossier status through each valid step to reach 'decided'.
3. Attempt to INSERT a new `rvm_item` into the decided dossier.

**Expected:** Exception: `'Cannot modify entities in locked dossier (status: decided)'`. No item row created.

**Note on TEST 4 prerequisite:** To reach 'decided' status legitimately, we need a finalized decision. The approach will be:
- Walk the dossier through: draft -> registered -> in_preparation -> scheduled
- Then set up the decision chain with proper chair approval to trigger the cascade to 'decided'
- Then attempt the immutability test

### Cleanup

- All transient records documented in the post-test restore point.
- No deletion needed (records serve as evidence).

## Post-Test Deliverables

1. `Project Restore Points/RP-P8A-runtime-tests-pre.md` — pre-test state
2. `Project Restore Points/RP-P8A-runtime-tests-post.md` — post-test state with record IDs
3. `docs/phase8a_runtime_verification_log.md` — full evidence log with PASS/FAIL per test

## Technical Details

### Prerequisite Records for TEST 3 and 4

To test the chair approval gate and immutability cascade, these minimal records are needed:

```text
rvm_dossier (TEST 1 creates this)
  -> status walked: draft -> registered -> in_preparation -> scheduled
rvm_meeting (transient, status: draft)
rvm_agenda_item (links meeting + dossier)
rvm_decision (links agenda_item, is_final=false)
  -> TEST 3: attempt is_final=true without chair approval (must fail)
  -> Then: set chair_approved_at + chair_approved_by, set is_final=true (must succeed, cascades dossier to decided)
  -> TEST 4: attempt INSERT rvm_item into decided dossier (must fail)
```

### Files to Create/Modify

| File | Action |
|------|--------|
| `Project Restore Points/RP-P8A-runtime-tests-pre.md` | CREATE |
| `Project Restore Points/RP-P8A-runtime-tests-post.md` | CREATE |
| `docs/phase8a_runtime_verification_log.md` | CREATE |

No changes to `docs/backend.md` or `docs/architecture.md` — these files do not exist in the project. The verification log will be self-contained.

### Stop Condition

After producing the runtime verification log, STOP. No Phase 8B work until runtime status is PASS and explicitly approved.

