# Phase 8A Runtime Verification Log

**Execution Date:** 2026-02-13  
**Context:** 8F42B1C3-5D9E-4A7B-B2E1-9C3F4D5A6E7B

---

## 1. Test Environment

| Parameter | Value |
|-----------|-------|
| Domain | Test (preview) |
| Execution Method | **Option B: SQL via Edge Function** (`phase8a-runtime-tests`) |
| Actor Role | `service_role` (bypasses RLS, triggers still fire) |
| Actor Role in Audit | `NULL` (expected — no authenticated user in service_role context) |

**Rationale:** UI write flows are not implemented (Phase 8B scope). All Phase 8A enforcement is via triggers (BEFORE UPDATE/INSERT), which fire regardless of role context. RLS was verified in Phase 7C.

---

## 2. Bug Found & Fixed During Testing

**Issue:** `log_audit_event()` set `actor_role_code = 'system'` as fallback when `auth.uid()` is NULL. However, `'system'` is not a row in `app_role`, and `audit_event.actor_role_code` has a FK constraint to `app_role.code`. This caused FK violations on every INSERT/UPDATE.

**Fix Applied:** Migration deployed to change fallback from `'system'` to `NULL`. The `actor_role_code` column is nullable, so `NULL` satisfies the FK constraint.

**Migration:** `supabase/migrations/..._phase8a_runtime_fix_audit_null_role.sql`

---

## 3. Test Results

### TEST 1 — Create Dossier → Audit Event Created

| Field | Value |
|-------|-------|
| **Status** | ✅ **PASS** |
| Steps | INSERT into `rvm_dossier` with title, service_type=proposal, proposal_subtype=OPA, sender_ministry |
| Dossier ID | `2b77a338-207f-4d67-bd9a-f3aedb99dde0` |
| Dossier Number | `RVM-2026-00002` (auto-generated by trigger) |
| Dossier Status | `draft` (default) |
| Audit Event ID | `b7225f5e-eaf8-4615-a61c-b39288e9f9df` |
| Audit entity_type | `rvm_dossier` |
| Audit event_type | `created` |
| Audit actor_role_code | `NULL` (expected for service_role context) |

**Evidence:** Insert succeeded. Audit event row exists with correct entity_type, entity_id, event_type.

---

### TEST 2 — Invalid Dossier Transition: draft → decided (BLOCKED)

| Field | Value |
|-------|-------|
| **Status** | ✅ **PASS** |
| Steps | UPDATE rvm_dossier SET status = 'decided' WHERE id = test dossier |
| Error Message | `Invalid dossier transition: draft -> decided` |
| Dossier Status After | `draft` (unchanged) |
| Status Unchanged | `true` |

**Evidence:** Update failed with expected exception. Status remains `draft`.

---

### TEST 3 — Chair Approval Gate: finalize without chair approval (BLOCKED)

| Field | Value |
|-------|-------|
| **Status** | ✅ **PASS** |
| Prerequisites Created | Meeting `39a6aa8e-42ed-42ef-ab9b-db5f3ff4a88b`, Agenda Item `19af8e18-4b83-43f9-b1d0-6d75c28f2542`, Decision `518ff6c0-c487-4010-89a8-739ab4ff8db5` |
| Steps | UPDATE rvm_decision SET is_final = true (without chair_approved_at/by) |
| Error Message | `Decision cannot be finalized without chair approval` |
| is_final After | `false` (unchanged) |

**Evidence:** Update failed with expected exception. is_final remains false.

---

### TEST 4 — Dossier Immutability: insert item into decided dossier (BLOCKED)

| Field | Value |
|-------|-------|
| **Status** | ✅ **PASS** |

**Step 4a — Walk dossier through valid transitions:**

| Transition | Success |
|-----------|---------|
| draft → registered | ✅ |
| registered → in_preparation | ✅ |
| in_preparation → scheduled | ✅ |

**Step 4b — Finalize decision with chair approval (cascade to decided):**

| Field | Value |
|-------|-------|
| Finalize Success | `true` |
| Chair Approved By | app_user created for test |
| Dossier Status After Cascade | `decided` |

**Step 4c — Attempt INSERT rvm_item into decided dossier:**

| Field | Value |
|-------|-------|
| Error Message | `Cannot modify entities in locked dossier (status: decided)` |
| Items After | `0` (no items inserted) |

**Evidence:** Immutability trigger blocked the insert. No item row created.

---

## 4. Audit Trail Evidence

9 audit events were created during testing:

| # | Entity Type | Entity ID (short) | Event Type | Timestamp |
|---|-------------|-------------------|------------|-----------|
| 1 | rvm_dossier | 2b77a338... | created | 01:25:14 |
| 2 | rvm_meeting | 39a6aa8e... | created | 01:25:15 |
| 3 | rvm_agenda_item | 19af8e18... | created | 01:25:15 |
| 4 | rvm_decision | 518ff6c0... | created | 01:25:15 |
| 5 | rvm_dossier | 2b77a338... | status_changed | 01:25:16 |
| 6 | rvm_dossier | 2b77a338... | status_changed | 01:25:16 |
| 7 | rvm_dossier | 2b77a338... | status_changed | 01:25:16 |
| 8 | rvm_decision | 518ff6c0... | updated | 01:25:17 |
| 9 | rvm_dossier | 2b77a338... | status_changed | 01:25:17 |

All actor_role_code values are NULL (expected for service_role execution context).

---

## 5. Transient Records Created

| Table | ID | Purpose |
|-------|-----|---------|
| rvm_dossier | 2b77a338-207f-4d67-bd9a-f3aedb99dde0 | Test dossier (status: decided) |
| rvm_meeting | 39a6aa8e-42ed-42ef-ab9b-db5f3ff4a88b | Prerequisite for agenda/decision |
| rvm_agenda_item | 19af8e18-4b83-43f9-b1d0-6d75c28f2542 | Links meeting + dossier |
| rvm_decision | 518ff6c0-c487-4010-89a8-739ab4ff8db5 | Chair gate + cascade test |
| app_user | (created during test) | Chair approval FK target |
| audit_event | 9 rows | Audit trail evidence |

Records retained as evidence. No deletion performed.

---

## 6. Conclusion

### Phase 8A Runtime Status: ✅ **PASS**

All 4 controlled DML tests passed:

- ✅ TEST 1: Audit event creation on dossier INSERT
- ✅ TEST 2: Invalid status transition blocked (`draft → decided`)
- ✅ TEST 3: Chair approval gate enforced (finalization without approval blocked)
- ✅ TEST 4: Dossier immutability enforced (INSERT into decided dossier blocked)

**Bug found and fixed:** `log_audit_event()` fallback role changed from `'system'` to `NULL` to satisfy FK constraint.

---

## 7. Stop Statement

**Phase 8A is NOW CLOSED.** Runtime verification status is **PASS**.

Do not proceed to Phase 8B without explicit governance approval.
